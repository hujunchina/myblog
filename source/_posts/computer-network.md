---

title: 计算机网络
date: 2020-10-25 23:47:15
categories:
	- 必备知识
tags:
	- 编程
	- 计算机网络
	- TCP
---

# 1. 计算机网络概述

## 1.1 互联网三个阶段

### 1.1.1 第一阶段：ARPANET

1969年在美国诞生的第一个互联网，国家性质的局部网络结构。因为多个机构使用，演变为更大网络。

### 1.1.2 第二阶段：三级结构

1985年美国NSF建立的结构化网络，给更多的机构使用，即主干网、地区网、校企网。因为互联网普及，用户数剧增，近靠国家管理无法满足其扩展的速度。

### 1.1.3 第三阶段：多层次 ISP 结构

提供互联网服务的主体由政府变成了商业公司，即互联网服务提供商 ISP。他们提供了接入、IP租赁、路由转发等服务。多层次体现在：本地 ISP，地区 ISP，主干 ISP等多个层次。

### 1.1.4 小结

互联网的演变是为了满足更多人入网，形成了现在复杂的物理分层结构。比如入网本地联通运行商，本地联通又接入了华东联通，华东联通接入中国联通，中国联通接入亚洲网络，亚洲网络接入美国网络中心，最后才能访问 YouTube。

为了提高效率，地区 ISP 之间会建立 IXP 互联网交换点，这样就可以形成一个大的局域网，而不对外访问，且联通可以访问电信的。

![image-20200519103752298](/images/network01.png)

## 1.2. 互联网组成

### 1.2.1 分为核心部分与边缘部分

- 边缘部分：用户直接使用的
  - 进程间通信
  - C/S服务模式
  - P2P模式
- 核心部分：为边缘部分提供服务（连通与交换）
  - 路由器（分组交换，转发收到的分组）
  - 交换机（电路交换，链路层）

### 1.2.2 电路交换

建立起互联网是为了通信传输数据，这就要涉及数据的交换和转发。

对电信网而言，电话出现时也需要数据交换，但是电话不可能都是一对一的专线。所以出现了电路交换的方式，即所有电话接入到交换机中，让接线员临时从电路上接通一条线路让两者通话。电路交换就是共用电话线来通信。

电路交换很明显切换时间长，且线路利用率低（很多线路接通后不是一直有数据传输），需要改进。

![image-20201025235639475](/images/network02.png)

### 1.2.3 分组交换

发送一块数据叫报文，把报文按一定大小分为多个数据段，并加上首都，就叫做分组（package），也叫做包。

其实分组就是一个首部+数据段。所以路由器交换分组就是交换报文的一部分数据。

分组交换采用存储转发技术，把分组发送到路由器后并不是直接转发，而是根据网络的情况（拥塞等）选择合适的路径再转发（转发表找端口），这期间会把分组存储在路由器内存中。

![image-20201025235331485](/images/network03.png)

分组交换很明显会产生时延，由于线路共用还会产生丢包、粘包问题等。

还有一个是报文交换，即不对报文分组直接交换，其延时更长。

## 1.3. 互联网类别

WAN、MAN、LAN、PAN

## 1.4. 计算机网络能指标及特征

### 1.4.1 速率

即二进制比特每秒传输量，单位是bps（bit per second）。

### 1.4.2 带宽

分为频域带宽（每秒通过的频率范围赫兹）和时域带宽（即速率）。

### 1.4.3 吞吐量

单位时间内通过网络的实际数据量。比如 Java 处理一个 Http 请求的吞吐量等。时间不一定是每秒，传输单位不一定是比特，可以是字节或帧等。

### 1.4.4 时延

总时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延

![image-20201025235445286](/images/network04.png)

- 发送时延（主机或路由器发送数据帧所需要的时间）= 数据帧长度 / 发送速率
- 传播时延（电磁波在信道中传播耗时）= 信道长度 / 传播速率
- 处理时延（处理分组的时间，包括获取端口和目的地 IP等）
- 排队时延（由于分组交换采用存储转发技术，会产生排队情况）

### 1.4.5 时延带宽积

时延带宽积 = 传播时延 X 带宽（以比特为单位的链路长度）。

类似求圆柱体的体积，表示这个链路能容纳多说 bit。

### 1.4.6 往返时间 RTT

通信是双向的，需要计算两者的来回时间，可以更全面准确判断真实传输速率。

有效数据率 = 数据长度 / (发送时间+RTT)

### 1.4.7 利用率

即信道使用率，一段时间传输数据与不传输数据空闲所占时间比。

## 1.5. 计算机网络体系结构

### 1.5.1 五层网络协议

对比OSI 协议和 TCPIP 协议，采用折中的五层网络协议。

协议：包括语法、语义、同步。

- 应用层：DNS，SMTP，HTTP，FTP （报文）
- 运输层：TCP（报文段），UDP（用户数据报）
- 网络层：IP（分组或数据报）
- 数据链路层：（帧）
- 物理层：（比特）

![image-20201025235530361](/images/network05.png)

# 2. 物理层

## 2.1. 物理层基本概念

解决传输媒体与通信手段的差异，让数据传输对数据链路层是透明的。

物理层包括定义传输数据的物理介质，比特流开始结束位，校验方式，电压引脚等。

## 2.2. 通信模型

### 2.2.1 信号编码与载波

信源→信道→信宿，消息从信源沿着信道传输到信宿。中间有编码解码（数字信号）或调制解调（模拟信号）。

电路和信道不同，一条电路可以包括发送信道和接收信道。可分为单向信道，双向交替信道，双向同时信道。

从信源发送的是基带信号，因其往往包含低频成分或直流成分，需要调制或编码，以利于传输（信号丢失）。

- 基带调制（编码）：数字信号转为另一种数字信号，如[0, 0.1] -> [0, 3.3]

  - 不归零制：正电平为1，负电平为0
  - 归零制：正脉冲为1， 负脉冲为0
  - 曼彻斯特编码：位周期中心向下跳变为1，位周期中心向上跳变为0
  - 差分曼彻斯特编码：边界不跳变代表1， 边界跳变代表0

  ![image-20201025235818518](/images/network06.png)

  从自同步能力来看，不归零制不能从信号波形本身中提取信号时钟频率（这叫作没有自同步能力），**而曼彻斯特编码和差分曼彻斯特编码具有自同步能力**。

- 带通调制（载波）：把基带信号的频率范围搬移到较高的频段，并转为模拟信号（传统拨号上网）

  - 调幅（AM）：载波的振幅随基带数字信号而变化
  - 调频（FM）：载波的频率随基带数字信号而变化
  - 调相（PM）：载波的初始相位随基带数字信号而变化

  ![image-20201025235848427](/images/network07.png)

  还有更高级的正交振幅调制（QAM）。

### 2.2.2 信噪比与香农公式

奈奎斯特准则：任何信道的码元传输速率都有上限，一旦超过就会出现码间串扰问题。

噪声无处不在，信号与噪声是相对的，只要一大一下就能保证信号传输正常。所以提出信噪比概念。

信噪比就是信号平均功率与噪声平均功率的比值，记S/N，单位分贝。

​								信噪比(dB) = 10 log10(S/N)   (dB)

1984年，香农 (Shannon) 用信息论的理论推导出了 带宽受限且有高斯白噪声干扰的信道的极限、无差错的信息传输速率（香农公式）极限速率C，W是信道带宽：

​								C = W log2(1+S/N)   (bit/s)

信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高

用编码的方法 让每一个码元携带更多比特的信息量

## 2.3. 传输媒介

![image-20201025235911111](/images/network08.png)

下面的波段是针对无线通信的，比如短波、微波、卫星等。

## 2.4. 信道复用

### 2.4.1 频分复用与时分复用

- 频分复用 FDM ：同样的时间占用不同的频率带宽
- ![internet-9](/images/network09.png)
- 时分复用 TDM ：时间划分为一段段等长的时分复用帧
- ![internet-10](/images/network10.png)

### 2.4.2 波分复用 WDM

对光纤而言，不同波段载不同信息。

### 2.4.3 码分复用 CDM

码分多址 CMDA ：各用户使用经过特殊挑选的不同码型，因此彼此不会造成干扰。

每一个比特时间划分为 *m* 个短的间隔，称为码片(chip)。比如m为64，则 数据为1bit，每次需要发送64bit。

每个站分配的码片序列不仅必须各不相同，并且还必须互相正交(orthogonal)，即内积为0 。

通过内积为0可以过滤掉未发送消息的基站，得到发送消息的基站。

![internet-11](/images/network11.png)

## 2.5. 现在装宽带

FTTH （fiber to the home）光纤到户方式。

![internet-12](/images/network12.png)

# 3. 数据链路层

## 3.1. 概述

数据链路层属于通信模型底层第二层，主要是承接网络层IP数据分组的封装，及对物理层的二进制流拆封转换。

可大致分为点对点信道类型（使用 PPP 协议）和广播信道类型（使用 CSMA/CD 协议）。广播信道是多个主机共用一个共享信道通信，比较复杂。

该层解决三个问题：封装成帧、透明传输、差错检测。

该层包含硬件设备：网络适配器、转换器、集线器、网桥、以太网交换机等。

![internet-13](/images/network13.png)

## 3.2. 点对点信道

### 3.2.1 数据链路和帧定义

链路(link)是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。

数据链路(data link) 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

一般使用适配器（即网卡）来实现这些协议的硬件和软件，其包含物理层和数据链路层。

同时数据链路层传输的载体数据叫帧。

![internet-14](/images/network14.png)

### 3.2.2 如何解决三个问题

#### 3.2.2.1 封装成帧

封装成帧(framing)就是在一段数据（IP数据报）的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。首部和尾部的一个重要作用就是进行帧定界。

![internet-15](/images/network15.png)

- 帧首部用SOH（start of header）0x01表示
- 帧尾部用EOT（end of tail）0x04表示

这里封装的帧很简单，因为是点对点传输，每个通道都是固定已知的发送者和接受者，所以不用封装地址等其他信息，只需要加入首尾即可。

#### 3.2.2.2 透明传输

透明传输即要保证可以传输任何字段而不需要考虑是否与关键字冲突。比如可以传输SOH和EOT。

为了解决这个问题，可以使用字节填充或字符填充方式（插入转义字符）。

如果转义字符也出现了，那就在前面再加一个转义字符。

![internet-16](/images/network16.png)

#### 3.2.2.3 差错控制

传输过程中，受到干扰，比特位会变为0或1，发生比特差错。

误码率（传输错误的比特占所传输比特总数的比率）。

循环冗余检验 CRC，在发送端，先把数据划分为组。假定每组 *k* 个比特。假设待传送的一组数据 *M* = 101001（现在 *k* = 6）。我们在 *M* 的后面再添加供差错检测用的 *n* 位冗余码一起发送。 

在数据后面添加上的冗余码称为帧检验序列 FCS (Frame Check Sequence)。

仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受(accept)，要做到“可靠传输”（即发送什么就收到什么）就必须再加上确认和重传机制。 

### 3.2.3 点对点协议 PPP

用户使用拨号电话线接入因特网时，一般都是使用 PPP 协议。 

三部分组成：

- 一个将 IP 数据报封装到串行链路的方法
- 链路控制协议 LCP (Link Control Protocol)
- 网络控制协议 NCP (Network Control Protocol)

PPP 协议的帧格式：

- 标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）
- 地址字段 A 只置为 0xFF。地址字段实际上并不起作用
- 控制字段 C 通常置为 0x03
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节

![internet-17](/images/network17.png)

字符填充（异步传输）：

- 将信息字段中出现的每一个 0x7E 字节转变成为 2 字节序列(0x7D, 0x5E)
- 若信息字段中出现一个 0x7D 的字节, 则将其转变成为 2 字节序列(0x7D, 0x5D)
- 若信息字段中出现 ASCII 码的控制字符（即数值小于 0x20 的字符），则在该字符前面要加入一个 0x7D 字节，同时将该字符的编码加以改变

零比特填充（同步传输，不需要考虑位同步）：

- 在发送端，只要发现有 5 个连续 1，则立即填入一个 0。
- 接收端对帧中的比特流进行扫描。每当发现 5 个连续1时，就把这 5 个连续 1 后的一个 0 删除

![internet-18](/images/network18.png)

## 3.3. 广播信道

### 3.3.1 局域网的数据链路层

#### 3.3.1.1 共享通道的两种方式

- 静态划分信道（频分、时分、波分、码分）
- 动态媒体接入控制（多点接入）（随机接入，受控接入）

#### 3.3.1.2 以太网标准

- DIX Ethernet V2 是世界上第一个局域网产品（以太网）的规约
- IEEE 的 802.3 标准

### 3.3.2 适配器

网络接口板又称为通信适配器(adapter)或网络接口卡 NIC (Network Interface Card)，或“网卡”。

#### 3.3.2.1 适配器的重要功能：

- n进行串行/并行转换。
- n对数据进行缓存。
- n在计算机的操作系统安装设备驱动程序。
- n实现以太网协议。 

![i](/images/network19.png)

### 3.3.3 CSMA/CD 协议 

物理层需采用差分曼彻斯特编码，CSMA/CD 表示 Carrier Sense Multiple Access with Collision Detection

“多点接入”表示许多计算机以多点接入的方式连接在一根总线上

“载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞

### 3.3.4 以太网

#### 3.3.4.1 MAC 层

在局域网中，硬件地址又称为物理地址，或 MAC 地址 。

802 标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符，一个地址块可以生成224个不同的地址。这种 48 位地址称为 MAC-48，它的通用名称是EUI-48。

“MAC地址”实际上就是适配器地址或适配器标识符EUI-48。

#### 3.3.4.2 适配器检查 MAC 地址

适配器从网络上每收到一个 MAC 帧就首先用硬件检查 MAC 帧中的 MAC 地址，如果是发往本站的帧则收下，然后再进行其他的处理，否则就将此帧丢弃，不再进行其他的处理。

#### 3.3.4.3 MAC 帧的格式 

![internet-20](/images/network20.png)

同步码是为了发送端向接收端对码用的，告诉接收端下面就是数据了，请接收。

## 3.4. 扩展以太网

### 3.4.1 使用集线器（物理层）

优点：

- 使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信。

- 扩大了局域网覆盖的地理范围。

缺点：

- 碰撞域增大了，但总的吞吐量并未提高。

- 如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互连起来。  

### 3.4.2 使用网桥（数据链路层）

网桥工作在数据链路层，它根据 MAC 帧的目的地址对收到的帧进行转发。

网桥具有过滤帧的功能。当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口。

![internet-21](/images/network21.png)

使用hyperV时候，需要搭建网络，当设置外部网络时，会在虚拟机和真实网络主机之间建立一个网桥。

主机是一个碰撞域（192.168.124.7），虚拟机是另一个碰撞域（124.168.173.2）

网桥在转发帧之前必须执行 CSMA/CD 算法，若在发送过程中出现碰撞，就必须停止发送和进行退避。

### 3.4.3 以太网交换机（数据链路层）

交换式集线器常称为以太网交换机(switch)或第二层交换机（表明此交换机工作在数据链路层）。

以太网交换机通常都有十几个接口。因此，以太网交换机实质上就是一个多接口的网桥，可见交换机工作在数据链路层。

以太网交换机的每个接口都直接与主机相连，并且一般都工作在全双工方式。

交换机能同时连通许多对的接口，使每一对相互通信的主机都能像独占通信媒体那样，进行无碰撞地传输数据。

以太网交换机由于使用了专用的交换结构芯片，其交换速率就较高。

## 4.1. 网络层概述

### 4.1.1 网络层提供服务

历史争论：面向连接的稳定的服务或无连接尽最大努力的服务。根据电话网特点，一但线路联通，就是稳定的，所以网络层联通后也要是稳定的。由于终端的不一样，电脑比电话智能且复杂，电脑可以控制错误，还有一点网络上的终端不是单一的，有很多异构网络和异构设备，所以采用无连接的最好。

面向连接需要建立虚电路

从而把面向连接推给了上层即运输层。

### 4.1.2 网络层特点

网络层向上只提供简单灵活的、无连接的、尽最大努力交付的数据报服务。

网络在发送分组时不需要先建立连接。每一个分组（即 IP 数据报）独立发送，与其前后的分组无关（不进行编号）。

网络层不提供服务质量的承诺。即所传送的分组可能出错、丢失、重复和失序（不按序到达终点），当然也不保证分组传送的时限。 

## 4.2. 网际协议 IP

### 4.2.1 网络层协议架构

网际协议 IP 是 TCP/IP 体系中两个最主要的协议之一。与 IP 协议配套使用的还有三个协议：

地址解析协议 ARP  (Address Resolution Protocol)

网际控制报文协议 ICMP  (Internet Control Message Protocol)

网际组管理协议 IGMP  (Internet Group Management Protocol)

需要注意，IP协议使用了ARP协议，而ICMP和IGMP使用了IP协议。

![ip-1](/images/network22.png)

### 4.2.2 网络中间件

中间设备又称为中间系统或中继(relay)系统。

物理层中继系统：转发器(repeater)。

数据链路层中继系统：网桥或桥接器(bridge)。

网络层中继系统：路由器(router)。

网桥和路由器的混合物：桥路器(brouter)。

网络层以上的中继系统：网关(gateway)（由于历史的原因，许多有关 TCP/IP 的文献将网络层使用的路由器称为网关。  ）

### 4.2.3 虚拟互联网络

虽然网络各终端使用了物理设备连接在一起，但是这对于软件系统是不可见和不可操作管理的，我们就需要一个软网络即虚拟互联网络。

所谓虚拟互连网络也就是逻辑互连网络，它的意思就是互连起来的各种物理网络的异构性本来是客观存在的，但是我们利用 IP 协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络。

使用 IP 协议的虚拟互连网络可简称为 IP 网，使用虚拟互连网络的好处是：当互联网上的主机进行通信时，就好像在一个网络上通信一样，而看不见互连的各具体的网络异构细节。

### 4.2.4 分类的 IP 地址

每一类地址都由两个固定长度的字段组成，其中一个字段是网络号 net-id，它标志主机（或路由器）所连接到的网络，而另一个字段则是主机号 host-id，它标志该主机（或路由器）。

​					IP 地址 ::= { <网络号>, <主机号>}    

![ip-2](/images/network23.png)

![ip-3](/images/network24.png)

好处：方便管理、方便路由寻表（只要配对网络号即可）

### 4.2.5 IP 地址与 MAC 地址

一个物理硬件地址与硬件绑定，一个是逻辑软件地址由程序系统设定。

IP层抽象的互联网屏蔽了下层很复杂的细节，在抽象的网络层上讨论问题，就能够使用统一的、抽象的 IP 地址研究主机和主机或主机和路由器之间的通信。

### 4.2.6 地址解析协议 ARP

![ip-4](/images/network25.png)

IP 协议利用ARP协议找到MAC地址。

不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址。  

网络层到数据链路层即数据报被封装为数据帧，就需要MAC地址来传递，所以知道了对方的IP地址，必须要找到对方的MAC地址，才能在下层传输。

每一个主机都设有一个 ARP 高速缓存(ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表。

当没有该MAC地址时，ARP会广播找MAC，对方端响应后单播发给ARP并保存。

### 4.2.7 为什么不能直接用MAC地址通信？

由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。

连接到因特网的主机都拥有统一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为调用 ARP 来寻找某个路由器或主机的硬件地址都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。

### 4.2.8 IP 协议数据报格式

![ip-5](/images/network26.png)

## 4.3. 划分子网和构造超网

### 4.3.1 三级IP地址

划分子网就是从主机号借用若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。 

​				IP地址 ::= {<网络号>, <子网号>, <主机号>}       

### 4.3.2 子网掩码

从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分。使用子网掩码(subnet mask)可以找出 IP 地址中的子网部分

![ip-6](/images/network27.png)

### 4.3.3 无分类编址 CIDR

IP地址 ::= {<网络前缀>, <主机号>}      

128.14.32.0/20 表示的地址块共有 212 个地址（因为斜线后面的 20 是网络前缀的位数，所以这个地址的主机号是 12 位）。

这个地址块的起始地址是 128.14.32.0。

在不需要指出地址块的起始地址时，也可将这样的地址块简称为“/20 地址块”。

128.14.32.0/20 地址块的最小地址：128.14.32.0

128.14.32.0/20 地址块的最大地址：128.14.47.255

全 0 和全 1 的主机号地址一般不使用。

## 4.4. 网际控制报文协议 ICMP

### 4.4.1 定义

为了提高 IP 数据报交付成功的机会，在网际层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)。

ICMP 允许主机或路由器报告差错情况和提供有关异常情况的报告。ICMP 不是高层协议，而是 IP 层的协议。

ICMP 报文作为 IP 层数据报的数据，加上数据报的首部，组成 IP 数据报发送出去。  

### 4.4.2 应用

PING (Packet InterNet Groper) 使用了 ICMP 回送请求与回送回答报文。是应用层直接使用网络层 ICMP 的例子，它没有通过运输层的 TCP 或UDP。 

Traceroute （tracert）命令用来列出中间经过的所有IP地址，通过TTL设置跳转数字来确定1，2等。

## 4.5. 因特网的路由选择协议

### 4.5.1 两大类路由选择协议 

n内部网关协议 IGP (Interior Gateway Protocol)  即在一个自治系统内部使用的路由选择协议。目前这类路由选择协议使用得最多，如 RIP 和 OSPF 协议。

n外部网关协议EGP (External Gateway Protocol)  若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议 EGP。在外部网关协议中目前使用最多的是 BGP-4。 

### 4.5.2 内部网关协议 RIP (Routing Information Protocol)

n路由信息协议 RIP 是内部网关协议 IGP中最先得到广泛使用的协议。

nRIP 是一种分布式的基于距离向量的路由选择协议。

nRIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。 

### 4.5.3 内部网关协议 OSPF (Open Shortest Path First)

n“开放”表明 OSPF 协议不是受某一家厂商控制，而是公开发表的。

n“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF

nOSPF 只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

n是分布式的链路状态协议。 

### 4.5.4 外部网关协议 BGP

n因特网的规模太大，使得自治系统之间路由选择非常困难。对于自治系统之间的路由选择，要寻找最佳路由是很不现实的。

n当一条路径通过几个不同 AS 时，要想对这样的路径计算出有意义的代价是不太可能的。

n比较合理的做法是在 AS 之间交换“可达性”信息。  

n自治系统之间的路由选择必须考虑有关策略。

n因此，边界网关协议 BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非要寻找一条最佳路由。 

## 4.6. IP 多播

多播使用组地址—— IP 使用 D 类地址支持多播。多播地址只能用于目的地址，而不能用于源地址。 

(2) 永久组地址——由因特网号码指派管理局 IANA 负责指派。

(3) 动态的组成员 

(4) 使用硬件进行多播

为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP (Internet Group Management Protocol)。

连接在局域网上的多播路由器还必须和因特网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用多播路由选择协议。 

## 4.7. 虚拟专用网 VPN 和网络地址转换 NAT

本地地址——仅在机构内部使用的 IP 地址，可以由本机构自行分配，而不需要向因特网的管理机构申请。

全球地址——全球唯一的IP地址，必须向因特网的管理机构申请。 

网络地址转换 NAT (Network Address Translation)

# 5.运输层

## 5.1. 运输层概述

### 5.1.1 进程间通信

从通信和信息处理的角度看，运输层向它上面的应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最低层。

两个主机进行通信实际上就是两个主机中的应用进程互相通信。 应用进程之间的通信又称为端到端的通信。

运输层提供应用进程间的逻辑通信。

运输层的一个很重要的功能就是复用和分用。应用层不同进程的报文通过不同的端口向下交到运输层，再往下就共用网络层提供的服务。

### 5.1.2 与网络层区别

真正通信的实体是进程，网络层只是把数据送到主机，这无法完成通信，所以设计运输层完成进程最后一公里通信。

运输层为应用进程之间提供端到端的逻辑通信（但网络层是为主机之间提供逻辑通信）。

运输层还要对收到的报文进行差错检测。（网络层只检测帧头部CRC，对数据体不检测）

运输层需要有两种不同的运输协议，即面向连接的 TCP 和无连接的 UDP。  

### 5.1.3 两种协议

传输控制协议 TCP  (Transmission Control Protocol)：当运输层采用面向连接的 TCP 协议时，尽管下面的网络是不可靠的（只提供尽最大努力服务），但这种逻辑通信信道就相当于一条全双工的可靠信道。

用户数据报协议 UDP  (User Datagram Protocol)：当运输层采用无连接的 UDP 协议时，这种逻辑通信信道是一条不可靠信道。 

两个对等运输实体在通信时传送的数据单位叫作运输协议数据单元 TPDU (Transport Protocol Data Unit)。

TCP 传送的数据单位协议是 TCP 报文段(segment)

UDP 传送的数据单位协议是 UDP 报文或用户数据报。 

UDP 在传送数据之前不需要先建立连接。对方的运输层在收到 UDP 报文后，不需要给出任何确认。虽然 UDP 不提供可靠交付，但在某些情况下 UDP 是一种最有效的工作方式。

TCP 则提供面向连接的服务。TCP 不提供广播或多播服务。由于 TCP 要提供可靠的、面向连接的运输服务，因此不可避免地增加了许多的开销。这不仅使协议数据单元的首部增大很多，还要占用许多的处理机资源。 

运输层的 UDP 用户数据报与网际层的IP数据报有很大区别。IP 数据报要经过互连网中许多路由器的存储转发，但 UDP 用户数据报是在运输层的端到端抽象的逻辑信道中传送的。

TCP 报文段是在运输层抽象的端到端逻辑信道中传送，这种信道是可靠的全双工信道。但这样的信道却不知道究竟经过了哪些路由器，而这些路由器也根本不知道上面的运输层是否建立了 TCP 连接。

### 5.1.4 端口

运输层既然是进程间的通信，就需要像IP一样对进程进行标记，那就是端口。端口用一个 16 位端口号进行标志。

虽然通信的终点是应用进程，但我们可以把端口想象是通信的终点，因为我们只要把要传送的报文交到目的主机的某一个合适的目的端口，剩下的工作（即最后交付目的进程）就由 TCP 来完成。

## 5.2. UDP协议

### 5.2.1 概述

UDP 只在 IP 的数据报服务之上增加了很少一点的功能，即端口的功能和差错检测的功能。

虽然 UDP 用户数据报只能提供不可靠的交付，但 UDP 在某些方面有其特殊的优点。

- UDP 是无连接的，即发送数据之前不需要建立连接。

- UDP 使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制。

- UDP 是面向报文的。UDP 没有拥塞控制，很适合多媒体通信的要求。

- UDP 支持一对一、一对多、多对一和多对多的交互通信。

- UDP 的首部开销小，只有 8 个字节。

UDP 因为没有拥塞控制，所以不会因网络拥塞而降低发送速率，会以一定的速率不停地发送数据，这样实时直播就得到了保证。不然播放会卡顿。

## 5.3. TCP协议

### 5.3.1 概述

TCP 是面向连接的运输层协议。每一条 TCP 连接只能有两个端点(endpoint)，每一条 TCP 连接只能是点对点的（一对一）。 TCP 提供可靠交付的服务。TCP 提供全双工通信。面向字节流。 

- TCP 连接是一条虚连接而不是一条真正的物理连接。

- TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的。
- TCP 根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。
- TCP 可把太长的数据块划分短一些再传送。TCP 也可等待积累有足够多的字节后再构成报文段发送出去。

### 5.3.2 套接字

TCP 连接的端点不是主机，不是主机的IP 地址，不是应用进程，也不是运输层的协议端口。TCP 连接的端点叫做套接字(socket)或插口。

端口号拼接到(contatenated with) IP 地址即构成了套接字。这里socket与通信中socket和应用层的socket不同。

## 5.4. TCP原理

### 5.4.1 停止等待协议

包括出差错的超时重传，所以必须要保存分组的副本，还要进行编号，设计超时RTT。

还有确认丢失和确认迟到。

使用上述的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。

这种可靠传输协议常称为自动重传请求ARQ (Automatic Repeat reQuest)。

ARQ 表明重传的请求是自动进行的。接收方不需要请求发送方重传某个出错的分组 。

但停止等待协议的优点是简单，但缺点是信道利用率太低。 

### 5.4.2 连续 ARQ 协议

这里是对ARQ的改进，传统ARQ是收到一个字节确认一下，这里是使用滑动窗口，只要确认最后一个字节，默认前面的字节都收到了。

接收方一般采用累积确认的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认，这样就表示：到这个分组为止的所有分组都已正确收到了。

累积确认有的优点是：容易实现，即使确认丢失也不必重传。缺点是：不能向发送方反映出接收方已经正确收到的所有分组的信息。

### 5.4.3 可靠实现

- TCP 连接的每一端都必须设有两个窗口——一个发送窗口和一个接收窗口。

- TCP 的可靠传输机制用字节的序号进行控制。TCP 所有的确认都是基于序号而不是基于报文段。

- TCP 两端的四个窗口经常处于动态变化之中。
- TCP连接的往返时间 RTT 也不是固定不变的。需要使用特定的算法估算较为合理的重传时间。 

![internet-24](/images/network28.png)

## 5.5. TCP可靠性实现

### 5.5.1 以字节为单位的滑动窗口

![internet-25](/images/network29.png)

发送缓存用来暂时存放：发送应用程序传送给发送方 TCP 准备发送的数据；TCP 已发送出但尚未收到确认的数据。

接收缓存用来暂时存放：按序到达的、但尚未被接收应用程序读取的数据；不按序到达的数据。

### 5.5.2 超时重传时间的选择

重传机制是 TCP 中最重要和最复杂的问题之一。

TCP 每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到但还没有收到确认，就要重传这一报文段。

超时重传时间 RTO 的计算。

修正的 Karn 算法： 报文段每重传一次，就把 RTO 增大一些，当不再发生报文段的重传时，才根据报文段的往返时延更新平均往返时延 RTT 和超时重传时间 RTO 的数值。

### 5.5.3 选择确认 SACK

接收方收到了和前面的字节流不连续的两个字节块。

如果这些字节的序号都在接收窗口之内，那么接收方就先收下这些数据，但要把这些信息准确地告诉发送方，使发送方不要再重复发送这些已收到的数据。

## 5.6. TCP流量控制

### 5.6.1 利用滑动窗口实现流量控制

流量控制(flow control)就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞。

利用滑动窗口机制可以很方便地在 TCP 连接上实现流量控制。

### 5.6.2 持续计时器

TCP 为每一个连接设有一个持续计时器。

只要 TCP 连接的一方收到对方的零窗口通知，就启动持续计时器。

若持续计时器设置的时间到期，就发送一个零窗口探测报文段（仅携带 1 字节的数据），而对方就在确认这个探测报文段时给出了现在的窗口值。

若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器。若窗口不是零，则死锁的僵局就可以打破了。 

## 5.7. TCP拥塞控制

### 5.7.1 比较

n拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。

n拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。

n流量控制往往指在给定的发送端和接收端之间的点对点通信量的控制。 

n流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。

![internet-26](/images/network30.png)

### 5.7.2 设计

开环控制方法就是在设计网络时事先将有关发生拥塞的因素考虑周到，力求网络在工作时不产生拥塞。

闭环控制是基于反馈环路的概念。属于闭环控制的有以下几种措施： 

监测网络系统以便检测到拥塞在何时、何处发生。将拥塞发生的信息传送到可采取行动的地方。

调整网络系统的运行以解决出现的问题。

### 5.7.3 慢开始和拥塞避免

发送方维持一个叫做拥塞窗口 cwnd (congestion window)的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞窗口。如再考虑到接收方的接收能力，则发送窗口还可能小于拥塞窗口。

发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。

#### 5.7.3.1 慢开始算法的原理

n在主机刚刚开始发送报文段时可先设置拥塞窗口 cwnd = 1，即设置为一个最大报文段 MSS 的数值。

n在每收到一个对新的报文段的确认后，将拥塞窗口加 1，即增加一个 MSS 的数值。

n用这样的方法逐步增大发送端的拥塞窗口 cwnd，可以使分组注入到网络的速率更加合理。 

#### 5.7.3.2 传输轮次

n使用慢开始算法后，每经过一个传输轮次，拥塞窗口 cwnd 就加倍。

n一个传输轮次所经历的时间其实就是往返时间 RTT。

n“传输轮次”更加强调：把拥塞窗口 cwnd 所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个字节的确认。

n例如，拥塞窗口 cwnd = 4，这时的往返时间 RTT 就是发送方连续发送 4 个报文段，并收到这 4 个报文段的确认，总共经历的时间。

#### 5.7.3.3 设置慢开始门限状态变量ssthresh

n慢开始门限 ssthresh 的用法如下：

n当 cwnd < ssthresh 时，使用慢开始算法。

n当 cwnd > ssthresh 时，停止使用慢开始算法而改用拥塞避免算法。

n当 cwnd = ssthresh 时，既可使用慢开始算法，也可使用拥塞避免算法。

n拥塞避免算法的思路是让拥塞窗口 cwnd 缓慢地增大，即每经过一个往返时间 RTT 就把发送方的拥塞窗口 cwnd 加 1，而不是加倍，使拥塞窗口 cwnd 按线性规律缓慢增长。

### 5.7.3.4 当网络出现拥塞时

n无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有按时收到确认），就要把慢开始门限 ssthresh 设置为出现拥塞时的发送方窗口值的一半（但不能小于2）。

n然后把拥塞窗口 cwnd 重新设置为 1，执行慢开始算法。

n这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。

![internet-27](/images/network31.png)

当拥塞窗口 cwnd 增长到慢开始门限值 ssthresh 时（即当 cwnd = 16 时），就改为执行拥塞避免算法，拥塞窗口按线性规律增长。假定拥塞窗口的数值增长到 24 时，网络出现超时，表明网络拥塞了。更新后的 ssthresh 值变为 12（即发送窗口数值 24 的一半），拥塞窗口再重新设置为 1，并执行慢开始算法。当 cwnd = 12 时改为执行拥塞避免算法，拥塞窗口按按线性规律增长，每经过一个往返时延就增加一个 MSS 的大小。

#### 5.7.3.5 乘法减小

n“乘法减小“是指不论在慢开始阶段还是拥塞避免阶段，只要出现一次超时（即出现一次网络拥塞），就把慢开始门限值 ssthresh 设置为当前的拥塞窗口值乘以 0.5。

n当网络频繁出现拥塞时，ssthresh 值就下降得很快，以大大减少注入到网络中的分组数。

##### 5.47.3.6 加法增大

n“加法增大”是指执行拥塞避免算法后，在收到对所有报文段的确认后（即经过一个往返时间），就把拥塞窗口 cwnd增加一个 MSS 大小，使拥塞窗口缓慢增大，以防止网络过早出现拥塞。

### 5.7.4 快重传和快恢复

#### 5.7.4.1 快重传

快重传算法首先要求接收方每收到一个失序的报文段后就立即发出重复确认。这样做可以让发送方及早知道有报文段没有到达接收方。

发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段。

不难看出，快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。

#### 5.7.4.2 快恢复算法

当发送端收到连续三个重复的确认时，就执行“乘法减小”算法，把慢开始门限 ssthresh 减半。但接下去不执行慢开始算法。

(2)由于发送方现在认为网络很可能没有发生拥塞，因此现在不执行慢开始算法，即拥塞窗口 cwnd 现在不设置为 1，而是设置为慢开始门限 ssthresh 减半后的数值，然后开始执行拥塞避免算法（“加法增大”），使拥塞窗口缓慢地线性增大。

![internet-28](/images/network32.png)

发送方的发送窗口的上限值应当取为接收方窗口 rwnd 和拥塞窗口 cwnd 这两个变量中较小的一个，即应按以下公式确定：

发送窗口的上限值 = Min [rwnd, cwnd]         (5-8)

当 rwnd < cwnd 时，是接收方的接收能力限制发送窗口的最大值。

当 cwnd < rwnd 时，则是网络的拥塞限制发送窗口的最大值。

## 5.8. TCP连接管理

### 5.8.1 运输连接的三个阶段

n运输连接就有三个阶段，即：连接建立、数据传送和连接释放。运输连接的管理就是使运输连接的建立和释放都能正常地进行。

n连接建立过程中要解决以下三个问题：

n要使每一方能够确知对方的存在。

n要允许双方协商一些参数（如最大报文段长度，最大窗口大小，服务质量等）。

n能够对运输实体资源（如缓存大小，连接表中的项目等）进行分配。 

### 5.8.2 三报文握手

![internet-29](/images/network33.png)

A 的 TCP 向 B 发出连接请求报文段，其首部中的同步位 SYN = 1，并选择序号 seq = x，表明传送数据时的第一个数据字节的序号是 x。

B 的 TCP 收到连接请求报文段后，如同意，则发回确认。B 在确认报文段中应使 SYN = 1，使 ACK = 1，其确认号ack = x + 1，自己选择的序号 seq = y。

A 收到此报文段后向 B 给出确认，其 ACK = 1， 确认号 ack = y + 1。A 的 TCP 通知上层应用进程，连接已经建立。B 的 TCP 收到主机 A 的确认后，也通知其上层应用进程：TCP 连接已经建立。

>注意：这里SYN表示同步请求，是请求发送专用的，ACK表示应答回应，是回应回复专用的，所以只要是发送请求都是SYN=1关键字，回应都是ACK=1关键字。又因为SYN和ACK在报文中只有1位长度，需要带额外信息才能确认。SYN带seq，ACK带ack。每次回应的时候都是ack=seq+1。而请求新的seq=ack，表示对ack这条回应的再回应，不然不知道哪个消息。 

### 5.8.3 连接释放

![internet-30](/images/network34.png)

A 把连接释放报文段首部的 FIN = 1，其序号seq = u，等待 B 的确认。

B 发出确认，确认号 ack = u + 1，而这个报文段自己的序号 seq = v。TCP 服务器进程通知高层应用进程。 从 A 到 B 这个方向的连接就释放了，TCP 连接处于半关闭状态。B 若发送数据，A 仍要接收。

若 B 已经没有要向 A 发送的数据，其应用进程就通知 TCP 释放连接。 

A 收到连接释放报文段后，必须发出确认。 在确认报文段中 ACK=1，确认号 ack=w+1，自己的序号 seq=u+1。 

![internet-31](/images/network35.png)

# 6. 应用层概述

## 6.1 应用层产生

运输层解决了应用程序到应用程序直接的通信，但是应用程序的多个进程之间如何通信呢？比如进程A 要和 进程 B通信，通过传输层只能把数据送达到某个端口，但进程到端口和对端口的监听绑定等一系列的操作都需要规范化、都需要一种进程和端口之间的协议，这就是应用层了。

## 6.2 应用层特点

应用层提供了应用程序的进程之间的通信，通信就是从一个进程去存取另一个进程的文件或数据。所以应用层规定了很多这样的协议，如HTTP、FTP、TFTP、SOCEKT 等。这些都是通过客服和服务器模式工作的。客户clint 和服务器server都是专指应用程序中的两个进程，且这两个进程必须绑定并监听不同的端口。

## 6.3 域名服务系统 DNS

### 6.3.1 DNS 概述

感觉每一层都有一套自己的标志，比如数据链路层的物理地址，应用层的IP地址，运输层的端口号，对于应用层也不例外。为了达到双向访问，就需要指定名称的，这里如果使用IP+端口的方式，对我们很难记忆。所以设计了域名，即网络地址。在IP与域名之间做解析用了 DNS 服务。

### 6.3.2 域名结构

略，包含顶级域名、二级域名。

这里有一个权限域名服务器的概念，即在二级域名下，可以设定多个权限DNS来提供服务，每个都有不同IP。

如 course.zju.edu.cn 和 cst.zju.edu.cn 。

### 6.3.3 DNS 解析过程

当我们输入域名回车后，并不是直接就访问域名所在的服务器主机，因为还不知道这个主机的IP。需要调用解析程序，把域名放在DNS请求报文中，以UDP方式发送到本地域名服务器，去查询IP地址。DNS 查到 IP 后放入回答报文中，进程获得这个 IP 才开始真正的 HTTP 访问。

每个 DNS 都有一个域名高速缓存。

## 6.4. 文件传输协议

在 HTTP 还没有问世前，FTP 协议非常流行。

### 6.4.1 FTP 概述

FTP 协议在运输层使用 TCP 协议作为可靠连接。FTP 屏蔽了底层细节，提供了跨操作系统的文件读取。但对远程文件的修改，需要先把文件下载到本地修改后再上传。而不是直接在远程端修改。

网络文件系统 NFS 则提供了直接在远程端修改文件的服务。

### 6.4.2 FTP 原理

文件传送协议 FTP 只提供文件传送的一些基本的服务，它使用 TCP 可靠的运输服务。FTP 的主要功能是减少或消除在不同操作系统下处理文件的不兼容性。

FTP 使用客户服务器方式。一个 FTP 服务器进程可同时为多个客户进程提供服务。FTP 的服务器进程由两大部分组成：一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求。

从进程又可分为：控制进程和数据传输进程。所以每个 FTP 连接都是控制和传输分离的。

控制连接在整个会话期间一直保持打开，FTP 客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件。

实际用于传输文件的是“数据连接”。服务器端的控制进程在接收到 FTP 客户发送来的文件传输请求后就创建“数据传送进程”和“数据连接”，用来连接客户端和服务器端的数据传送进程。

数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”并结束运行。 

### 6.4.3 FTP 模拟

![internet-30](/images/network36.png)

首先服务端需要 主进程 监听21端口，然后客户通过自己的某个接口如1080连接成功后，从进程中的控制进程访问客户的1080端口进行控制通信，然后服务端数据传输进程通过 20 端口与客户进程的 20 端口建立数据传输通信。

所以，客户并不是真正的在21端口，而是通过访问21端口，请求服务器分配一个控制进程并绑定其他端口来处理这个请求，这样服务器才能同时相应多个客户的请求，避免21 端口长时间阻塞。

再就是控制进程端口和数据传输进程端口不同，是两个端口，防止控制和传输混乱。

### 6.4.4 TFTP 协议

上面的 FTP 是基于 TCP 的，这里 TFTP 协议是基于 UDP 的。

TFTP 是一个很小且易于实现的文件传送协议。TFTP 使用客户服务器方式和使用 UDP 数据报，因此 TFTP 需要有自己的差错改正措施。TFTP 只支持文件传输而不支持交互。TFTP 没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别。

### 6.4.5 TFTP 用途与特点

适用于小型设备、嵌入式设备等，这些设备不需要硬盘，只需要固化了的TFTP、UDP 和 IP 的小容量只读存储器即可。实现简单的文件传输。

每次传送的数据 PDU 中有 512 字节的数据，但最后一次可不足 512 字节。数据 PDU 也称为文件块(block)，每个块按序编号，从 1 开始。支持 ASCII 码或二进制传送。可对文件进行读或写。使用很简单的首部。  

## 6.5. 万维网 WWW

万维网是一个标准网络，提供了分布式超文本媒体传输的支持和协议。并通过统一资源定位符 URL 来解决媒体文件的唯一引用地址问题。通过 HTTP 协议解决媒体文件传输问题，通过 HTML 解决如何定义展示文件问题。

### 6.5.1 统一资源定位符 URL

URL 给资源的位置提供一种抽象的识别方法，并用这种方法给资源定位。只要能够对资源定位，系统就可以对资源进行各种操作，如存取、更新、替换和查找其属性。URL 相当于一个文件名在网络范围的扩展。因此 URL 是与因特网相连的机器上的任何可访问对象的一个指针。  

> <协议>://<主机>:<端口>/<路径>

### 6.5.2 超文本传送协议 HTTP

从层次的角度看，HTTP 是面向事务的(transaction-oriented)应用层协议，它是万维网上能够可靠地交换文件（包括文本、声音、图像等各种多媒体文件）的重要基础。 

HTTP 是基于 TCP 协议建立的连接，默认端口是80，HTTPS是443。所以要建立HTTP通信需要先建立TCP通信。

而且HTTP通信本事是无连接的，即发送报文之前不需要先建立HTTP连接（已经有TCP连接过了）。

HTTP之间每次交互都有一个 类MIME 的数据，里面包含了 URL，访问方式，协议等各种参数。

### 6.5.3 HTTP 连接过程 

浏览器进程首先使用 DNS 协议得到服务器主机的 IP ，然后根据这个IP和默认端口80，建立 TCP 连接。

建立 TCP 连接就是三报文握手：

> SYN=1，seq=k；

> SYN=1，seq=x，ACK=1，ack= k+1

> ACK=1，ack=x+1

然后，服务器主机根据穿过来的MIME中的URL定位资源，并把资源发送给客户端。

最后， TCP 连接断开，通信结束。

这里，在 HTTP 1.0 版本中，每次请求都要先建立 TCP 连接，是非持续连接，需要消耗 TCP 资源和主机资源。

 在 HTTP 1.1 版本中通过 KEEP-ALIVE 实现了持续连接，即建立 TCP 连接后，持续一段时间后才端口，而不是 HTTP 通信完成后就端口，可以发送多次 HTTP 请求应答。

持续连接有两种工作方式，一是非流水线方式，即串行方式，收到第一个请求的结果再发送第二个请求，TCP 中间有很多空闲状态造成资源浪费；另一种是流水线方式，即并行方式，连续发送请求。

### 6.5.4 代理服务器 

代理服务器(proxy server)又称为万维网高速缓存(Web cache)，它代表浏览器发出 HTTP 请求。

万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中。

当与暂时存放的请求相同的新请求到达时，万维网高速缓存就把暂存的响应发送出去，而不需要按 URL 的地址再去因特网访问该资源。

代理服务器就是高速缓存。

### 6.5.5 解决 HTTP 无状态

使用 Cookie 或 Seesion 技术。Cookie 保存了用户的唯一标识，每次请求都带上这个标识就能够确认用户是谁。

### 6.5.6 动态文档

静态文档是存放在服务器，不会改变，直接 URL 来访问即可。动态文档是动态生成的文档，需要对 URL 拦截并处理文档生成。

这里需要解决两个问题一个是要有应用程序去创建文档，一个是要有机制去拦截 URL。

这个机制就叫做 通用网关接口 CGI，是一种标准。实现该标准的叫 CGI程序或CGI脚本。如Tomcat，PHP等服务器。

还有一个叫活动文档，就是把程序放在客户端执行，如 Java 的 Applet 。

##  6.6. 动态主机配置协议 DHCP    

为了将软件协议做成通用的和便于移植，协议软件的编写者把协议软件参数化。这就使得在很多台计算机上使用同一个经过编译的二进制代码成为可能。

一台计算机和另一台计算机的区别，都可通过一些不同的参数来体现。在软件协议运行之前，必须给每一个参数赋值。 在协议软件中给这些参数赋值的动作叫做协议配置。

动态主机配置协议 DHCP 提供了即插即用连网(plug-and-play networking)的机制。n这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与。

就是自动获取IP，自动获取 DNS这些。

DHCP 服务器被动打开 UDP 端口 67，等待客户端发来的报文。DHCP 客户从 UDP 端口 68 发送 DHCP 发现报文。

### 6.7. 应用进程跨越网络的通信

刚才讲的 HTTP 协议是针对符合万维网的程序通信的，比如浏览器等，我们如何让自己的应用程序完成跨网络通信呢？如果再实现一遍 HTTP 协议未免太浪费了，应用程序通信只要满足数据的的读取就可以了。

### 6.7.1 系统调用

大多数操作系统使用系统调用(system call)的机制在应用程序和操作系统之间传递控制权。

对程序员来说，每一个系统调用和一般程序设计中的函数调用非常相似，只是系统调用是将控制权传递给了操作系统。

当某个应用进程启动系统调用时，控制权就从应用进程传递给了系统调用接口。

此接口再将控制权传递给计算机的操作系统。操作系统将此调用转给某个内部过程，并执行所请求的操作。

内部过程一旦执行完毕，控制权就又通过系统调用接口返回给应用进程。

系统调用接口实际上就是应用进程的控制权和操作系统的控制权进行转换的一个接口，即应用编程接口 API。 

### 6.7.2 自定义通信协议诞生

网络设计者为我们提供了 TCP/IP 标准但是没有规定具体的实施和语法实现。然后，Unix 定义了一套 API 来操作网络协议，并实现应用层的通信，他们把这套 API 叫做 套接字接口 Socket。Windows系统有自己的 WinSocket 。

![internet-33](/images/network37.png)

这就是现在各语言都支持网络编程的 Socket 通信，通过系统调用，在用户态和核心态交换，让应用程序通过操作系统执行通信来完成网络通信。

### 6.7.3 Socket 原理

当应用进程需要使用网络进行通信时就发出系统调用，请求操作系统为其创建“套接字”，以便把网络通信所需要的系统资源分配给该应用进程。

操作系统为这些资源的总和用一个叫做套接字描述符的号码来表示，并把此号码返回给应用进程。应用进程所进行的网络操作都必须使用这个号码。

通信完毕后，应用进程通过一个关闭套接字的系统调用通知操作系统回收与该“号码”相关的所有资源。

![internet-34](/images/network38.png)

当应用程序声明 Socket，或实例化 Socket 时，执行程序经过系统调用，进入内核态后，操作系统会分配资源给这个进程，比如存储区、网络带宽、CPU时间等。这些资源总和叫做套接字描述符文件，即一个很短的号码如 fd60

这些描述符有很多，所以就建立一个表来管理里面存了socket的指针。每个socket 存储了很多信息。

当实例化 socket 完成，操作系统把套接字描述符给应用程序使用。

### 6.7.4 Socket 阶段

应用程序仅仅是调用了 Socket 的 API，所有 socket 的操作都要用到系统调用，都要由操作系统完成。比如 bind、connect、listen、accept 等。

每个应用程序可有一个 socket 主进程（ServerSocket）和多个socket 从进程（Socket）。

![internet-35](/images/network39.png)

主进程 accept 到客户请求后，建立一个从进程 Socket 并连接新的套接字去单独处理这个客户机请求。



