---
title: 如何在已有的消息协议上改造？
date: 2020-10-26 10:10:44
categories:
	- 编程经验
tags:
	- 编程
	- JAVA
---

# Draft

以前定义的消息格式已经发布到线上了，如何对新版的命令格式发布？

思路：在消息处理逻辑要有个判断，需要一个版本标识，然后处理不同的消息。

```java
/**
 * 消息格式版本,默认1.0
 */
@JSONField(serialize = false)
private String cmdVersion = "1.0";
```

由于消息格式每个字段都要进行json化，对内部用的版本号不能被序列化。

有了版本标识，还需要对数据库进行处理：对版本保存。

因为每条指令数据都会保存，所以新增的版本字段也要落库以备查询。

数据库的设计有个亮点：不是简单的对旧数据表加一个字段，而是先将旧数据表改名备份`_cmd_old`，再新建一个带版本字段的数据表`cmd`。

这样的好处是当指令错误或无法业务无法兼容时，可以进行及时的回滚。还有一个问题，改变了数据表后，新的数据是否还要存储在旧数据表中？不用。

要有一个敏捷的意识，在编码时，需要获取一个字段，要用该类的get方法，而不是找其成员变量。

在处理指令内部字段的时候，可以维护一个HashMap来保存。

### Assert类

```
//表达式不为真，则报错，如果为真则通过
Assert.isTrue(express, "msg");
Assert.isTrue(false, "express is false catch exception")
```

